CREATE OR ALTER VIEW [dbo].[vFEEncabezado] AS
SELECT
  SUBSTRING(eNCF, 1, 1) AS TipoECFL,
  TipoECF,
  eNCF,
  FechaVencimientoSecuencia,
  IndicadorNotaCredito,
  IndicadorEnvioDiferido,
  IndicadorMontoGravado,
  TipoIngresos,
  TipoPago,
  FechaLimitePago,
  TerminoPago,
  TipoCuentaPago,
  NumeroCuentaPago,
  BancoPago,
  FechaDesde,
  FechaHasta,
  TotalPaginas,
  RNCEmisor,
  RazonSocialEmisor,
  NombreComercial,
  Sucursal,
  DireccionEmisor,
  Municipio,
  Provincia,
  TelefonoEmisor2,
  TelefonoEmisor1,
  TelefonoEmisor3,
  CorreoEmisor,
  WebSite,
  ActividadEconomica,
  CodigoVendedor,
  NumeroFacturaInterna,
  NumeroPedidoInterno,
  ZonaVenta,
  RutaVenta,
  InformacionAdicionalEmisor,
  FechaEmision,
  RNCComprador,
  IdentificadorExtranjero,
  RazonSocialComprador,
  ContactoComprador,
  CorreoComprador,
  DireccionComprador,
  MunicipioComprador,
  ProvinciaComprador,
  PaisComprador,
  FechaEntrega,
  ContactoEntrega,
  DireccionEntrega,
  TelefonoAdicional,
  FechaOrdenCompra,
  NumeroOrdenCompra,
  CodigoInternoComprador,
  ResponsablePago,
  Informacionadicionalcomprador,
  FechaEmbarque,
  NumeroEmbarque,
  NumeroContenedor,
  NumeroReferencia,
  NombrePuertoEmbarque,
  CondicionesEntrega,
  TotalFob,
  Seguro,
  Flete,
  OtrosGastos,
  TotalCif,
  RegimenAduanero,
  NombrePuertoSalida,
  NombrePuertoDesembarque,
  PesoBruto,
  PesoNeto,
  UnidadPesoBruto,
  UnidadPesoNeto,
  CantidadBulto,
  UnidadBulto,
  VolumenBulto,
  UnidadVolumen,
  ViaTransporte,
  PaisOrigen,
  DireccionDestino,
  PaisDestino,
  RNCIdentificacionCompaniaTransportista,
  NombreCompaniaTransportista,
  NumeroViaje,
  Conductor,
  DocumentoTransporte,
  Ficha,
  Placa,
  RutaTransporte,
  ZonaTransporte,
  NumeroAlbaran,
  MontoGravadoTotal,
  MontoGravadoI1,
  MontoGravadoI2,
  MontoGravadoI3,
  MontoExento,
  ITBIS1,
  ITBIS2,
  ITBIS3,
  TotalITBIS,
  TotalITBIS1,
  TotalITBIS2,
  TotalITBIS3,
  MontoImpuestoAdicional,
  MontoTotal,
  MontoNoFacturable,
  MontoPeriodo,
  SaldoAnterior,
  MontoAvancePago,
  ValorPagar,
  TotalITBISRetenido,
  TotalISRRetencion,
  TotalITBISPercepcion,
  TotalISRPercepcion,
  TipoMoneda,
  TipoCambio,
  MontoGravadoTotalOtraMoneda,
  MontoGravado1OtraMoneda,
  MontoGravado2OtraMoneda,
  MontoGravado3OtraMoneda,
  MontoExentoOtraMoneda,
  TotalITBISOtraMoneda,
  TotalITBIS1OtraMoneda,
  TotalITBIS2OtraMoneda,
  TotalITBIS3OtraMoneda,
  MontoImpuestoAdicionalOtraMoneda,
  MontoTotalOtraMoneda,
  NCFModificado,
  RNCOtroContribuyente,
  FechaNCFModificado,
  CodigoModificacion,
  RazonModificacion,
  trackid,
  FechaFirma,
  CodigoSeguridad,
  CodigoSeguridadCF,
  EstadoFiscal,
  fechacreacion,
  EstadoImpresion,
  ConteoImpresiones,
  null as Modificado,
  ResultadoEstadoFiscal,
  MontoDGII,
  MontoITBISDGII,
  CASE
    WHEN TipoECF = '32'
    AND MontoTotal < 250000 THEN CONCAT(
      'https://fc.dgii.gov.do/ecf/ConsultaTimbreFC?RncEmisor=',
      TRIM(RNCEmisor),
      '&ENCF=',
      TRIM(eNCF),
      '&MontoTotal=',
      MontoTotal,
      '&CodigoSeguridad=',
      [dbo].[FNCambiaHexadecimal] (TRIM(CodigoSeguridad))
    )
    WHEN TipoECF = '47' THEN CONCAT(
      'https://ecf.dgii.gov.do/ecf/ConsultaTimbre?RncEmisor=',
      TRIM(RNCEmisor),
      '&ENCF=',
      TRIM(eNCF),
      '&FechaEmision=',
      dbo.FNFechaDMY (FechaEmision),
      '&MontoTotal=',
      MontoTotal,
      '&FechaFirma=',
      REPLACE(TRIM(FechaFirma), ' ', '%20'),
      '&CodigoSeguridad=',
      [dbo].[FNCambiaHexadecimal] (CodigoSeguridad)
    )
    ELSE CONCAT(
      'https://ecf.dgii.gov.do/ecf/ConsultaTimbre?RncEmisor=',
      TRIM(RNCEmisor),
      '&RncComprador=',
      TRIM(RNCComprador),
      '&ENCF=',
      TRIM(eNCF),
      '&FechaEmision=',
      dbo.FNFechaDMY (FechaEmision),
      '&MontoTotal=',
      MontoTotal,
      '&FechaFirma=',
      REPLACE(TRIM(FechaFirma), ' ', '%20'),
      '&CodigoSeguridad=',
      [dbo].[FNCambiaHexadecimal] (TRIM(CodigoSeguridad))
    )
  END AS URLQR
FROM
  dbo.FEEncabezado GO
